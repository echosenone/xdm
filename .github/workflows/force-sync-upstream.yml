name: Force sync fork with upstream

on:
  workflow_dispatch:
  schedule:
    - cron: "12 20/12 * * *"

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Get upstream + default branch
        id: repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          DATA="$(gh api repos/${GITHUB_REPOSITORY})"
          PARENT_FULL_NAME="$(echo "$DATA" | jq -r '.parent.full_name // empty')"
          DEFAULT_BRANCH="$(echo "$DATA" | jq -r '.default_branch')"
          if [ -z "$PARENT_FULL_NAME" ]; then
            echo "Not a fork. Exiting."
            exit 0
          fi
          echo "upstream=$PARENT_FULL_NAME" >> $GITHUB_OUTPUT
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Force sync to upstream (push via PAT)
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
        run: |
          set -e
          UPSTREAM="https://github.com/${{ steps.repo.outputs.upstream }}.git"
          BRANCH="${{ steps.repo.outputs.branch }}"

          git remote add upstream "$UPSTREAM" || git remote set-url upstream "$UPSTREAM"
          git fetch upstream "$BRANCH" --prune
          git checkout "$BRANCH"
          git reset --hard "upstream/$BRANCH"

          # Push as YOU (PAT), so workflow files can be updated safely.
          git push "https://${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$BRANCH" --force-with-lease